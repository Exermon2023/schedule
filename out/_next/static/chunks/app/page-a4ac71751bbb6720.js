(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{1604:function(t,e,s){Promise.resolve().then(s.t.bind(s,328,23)),Promise.resolve().then(s.bind(s,9016))},9016:function(t,e,s){"use strict";s.r(e),s.d(e,{default:function(){return R}});var a,i,r=s(7437),n=s(2265),o=s(1872);(a=i||(i={}))[a.CREATED=1]="CREATED",a[a.WAIT_FOR_RETRY=2]="WAIT_FOR_RETRY",a[a.WAIT_FOR_NEXT_STAGE=3]="WAIT_FOR_NEXT_STAGE",a[a.SCHEDULED=8]="SCHEDULED",a[a.RUNNING=9]="RUNNING",a[a.FAILED=11]="FAILED",a[a.SUCCESS=12]="SUCCESS";let l=new Map([[1,"新建待调度"],[2,"等待重试"],[3,"等待下一阶段调度"],[8,"进入调度队列"],[9,"运行中"],[11,"失败"],[12,"成功"]]),d=["Status","RetryIndex","Log","ModifyTime","OrderTime"];class c{onUpdate(){this.modify_time=Date.now(),this.resetOrderTime()}resetOrderTime(){1===this.status?this.order_time=this.create_time-this.priority:3===this.status?this.order_time=this.modify_time-this.priority:2===this.status&&(this.order_time=this.modify_time+this.retry_interval[this.retry_index])}constructor(t,e,s="default",a=(0,o.Z)(),i=0,r=5,n=[100,200,300,500,1e3],l=10,d=0,c="",h="",_=0,u=1,g=0,p=[],x=Date.now(),y=Date.now(),m=Date.now()){this.task_type=t,this.context=e,this.user_id=s,this.task_id=a,this.version=i,this.max_retry_num=r,this.retry_interval=n,this.max_running_num=l,this.priority=d,this.stage_conf=c,this.stage=h,this.stage_progress=_,this.status=u,this.retry_index=g,this.log=p,this.order_time=x,this.create_time=y,this.modify_time=m}}class h{constructor(t,e){this.field_masks=t,this.task_data=e}}class _{async submitTask(t){let e="".concat(this.host,"/task/create");await this._jsonPost(e,{task_data:t})}async holdTask(t){let e="".concat(this.host,"/task/hold/").concat(t),s=await this._jsonPost(e),a=s.task_data;return new c(a.task_type,a.context,a.user_id,a.task_id,a.version,a.max_retry_num,a.retry_interval,a.max_running_num,a.priority,a.stage_conf,a.stage,a.stage_progress,a.status,a.retry_index,a.log,a.order_time,a.create_time,a.modify_time)}async resetTask(t){await this.updateTask(t,new h(d,new c("","","",t,0,0,[],0,0,"","",0,i.CREATED,0,[],0,0,new Date().getTime())))}async updateTask(t,e){let s="".concat(this.host,"/task/update/").concat(t);await this._jsonPost(s,e)}async getTasks(t,e,s){let a="".concat(this.host,"/task/list");return await this._jsonPost(a,{filter:t,offset:e,limit:s})}async _jsonPost(t){let e,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{return e=await fetch(t,{headers:{"Content-Type":"application/json"},body:JSON.stringify(s),method:"POST"}),await this._handleResponse(e)}catch(t){throw Error("RPC Request Client system error: ".concat(t))}}async _handleResponse(t){if(!t)return;if(t.status>=300){let e=t.headers.get("context-trace-id");throw Error("RPC internal error: ".concat(t.statusText,", trace: ").concat(e))}let e=await t.json();if(0===e.code||200===e.code)return e.data;throw Error("RPC internal error: ".concat(e.msg))}constructor(t){this.host=t}}let u=new _("http://8.138.58.80:8081");var g=s(5539),p=s(6052),x=s(7081),y=s(7840),m=s(1184),f=s(3877),k=s(5370),w=s(3618),j=s(5057),S=s(1468),T=s(9810);let{Link:v,Title:C}=y.default,E=[{title:"租户",dataIndex:"user_id",key:"user_id",fixed:"left",width:100},{title:"任务ID",dataIndex:"task_id",key:"task_id",fixed:"left",width:200},{title:"任务名称",dataIndex:"task_type",key:"task_type",fixed:"left",width:100},{title:"当前阶段",dataIndex:"stage",key:"stage",width:100},{title:"当前阶段进度",dataIndex:"stage_progress",key:"stage_progress",width:120},{title:"已重试次数",dataIndex:"retry_index",key:"retry_index",width:120},{title:"任务上下文",dataIndex:"context",key:"context",width:120,align:"center",render:(t,e)=>(0,r.jsx)(x.Z,{content:(0,r.jsx)("pre",{style:{whiteSpace:"pre-wrap",wordBreak:"break-word"},children:(0,r.jsx)("code",{children:JSON.stringify(JSON.parse(e.context),null,2)})}),trigger:"hover",children:(0,r.jsx)(v,{children:"详情"})})},{title:"任务状态",dataIndex:"status_play",key:"status_play",width:120},{title:"操作",dataIndex:"",key:"action",fixed:"right",responsive:["md"],width:100,render:(t,e)=>(0,r.jsx)(m.Z,{title:"重置任务",description:"确认要重置任务吗?",onConfirm:()=>{u.resetTask(e.task_id).then(()=>{f.ZP.success("重置成功"),window.location.reload()})},onCancel:()=>{f.ZP.error("取消重置")},okText:"Yes",cancelText:"No",children:(0,r.jsx)(p.ZP,{danger:!0,children:"重置"})})},{title:"日志",dataIndex:"log",fixed:"right",key:"log",render:(t,e)=>(0,r.jsx)(x.Z,{content:(0,r.jsx)("div",{children:e.log.map((t,e)=>(0,r.jsx)("p",{style:{margin:0},children:t},e))}),trigger:"hover",children:(0,r.jsx)(v,{children:"查看日志"})})}],I={marginBottom:"20px"},Z=t=>Math.floor(t/4)+1;var R=t=>{let{}=t,[e,s]=(0,n.useState)([]),[a,i]=(0,n.useState)(!0),[o,d]=(0,n.useState)({}),[c,h]=(0,n.useState)(0),[_,x]=(0,n.useState)(0),y=async()=>{let t=await u.getTasks(o,c,4);t.tasks||(t.tasks=[]),s(t.tasks.map(t=>(t.status_play=l.get(t.status),t))),x(t.count)};(0,n.useEffect)(()=>{i(!0),y().then(()=>i(!1))},[c]);let m=Array.from(l.entries()).map(t=>{let[e,s]=t;return{label:s,value:e}}),f=t=>e=>{if(e.target.value=e.target.value.trim(),!e.target.value){delete o[t],console.log("handleStatusSelect",o);return}o[t]=e.target.value,console.log("handleStatusSelect",o)};return(0,r.jsxs)("div",{children:[(0,r.jsxs)(k.Z,{style:I,justify:"space-between",children:[(0,r.jsx)(w.Z,{span:6,children:(0,r.jsxs)("div",{children:[(0,r.jsx)(C,{level:5,children:"任务ID"}),(0,r.jsx)(j.Z,{allowClear:!0,placeholder:"请输入任务ID",onChange:f("task_id")})]})}),(0,r.jsx)(w.Z,{span:6,children:(0,r.jsxs)("div",{children:[(0,r.jsx)(C,{level:5,children:"任务类型"}),(0,r.jsx)(j.Z,{allowClear:!0,placeholder:"请输入任务类型",onChange:f("task_type")})]})}),(0,r.jsxs)(w.Z,{span:6,children:[(0,r.jsx)(C,{level:5,children:"任务状态"}),(0,r.jsx)(S.Z,{style:{width:"100%"},allowClear:!0,placeholder:"请选择任务状态",onChange:t=>{if(!t){delete o.status,console.log("handleStatusSelect",o);return}o.status=t,console.log("handleStatusSelect",o)},options:m})]}),(0,r.jsxs)(w.Z,{children:[(0,r.jsx)(C,{level:5,children:"操作"}),(0,r.jsx)(p.ZP,{type:"primary",onClick:()=>{for(let t in o)o[t]||delete o[t];i(!0),d(o),h(0),y().then(()=>i(!1))},children:"查询"})]})]}),(0,r.jsx)(k.Z,{style:I,children:(0,r.jsx)(w.Z,{children:(0,r.jsx)(g.Z,{columns:E,dataSource:e,pagination:{current:Z(c),pageSize:4,total:_,showSizeChanger:!1,onChange:t=>{h((t-1)*4)}}})})}),(0,r.jsx)(T.Z,{spinning:a,fullscreen:!0})]})}},328:function(t){t.exports={main:"page_main__nw1Wk",description:"page_description__lvaOp",code:"page_code__9AfUJ",grid:"page_grid__JZ9Cz",card:"page_card__Cf__u",center:"page_center__NcdcW",logo:"page_logo__ikIZE",content:"page_content___38fW",vercelLogo:"page_vercelLogo__YYFl1",rotate:"page_rotate__xIioM"}}},function(t){t.O(0,[725,971,472,744],function(){return t(t.s=1604)}),_N_E=t.O()}]);